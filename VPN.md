

# Архитектура VPN-сервиса (VLESS/REALITY) — Control Plane + Nodes

## Цели и требования

- **1 ссылка подписки** для пользователя → внутри **список серверов** (DE-1/DE-2/DE-3 …).
    
- Основной протокол: **VLESS + TCP + REALITY** (максимум скорости и обход DPI).
    
- Резерв для мобильных/сложных сетей: **VLESS + gRPC + TLS** (стабильность).
    
- Монетизация: **Telegram-бот** (оплата → создание/продление подписки).
    
- Масштабирование: добавление новых серверов без миграций и “ручного ада”.
    
- Отказоустойчивость: падение одной ноды не ломает сервис.
    

---

## Высокоуровневая схема

```
                 ┌─────────────────────────┐
                 │        Telegram Bot      │
                 │ (billing / payments / UI)│
                 └────────────┬────────────┘
                              │ HTTPS (API)
                              ▼
        ┌────────────────────────────────────────┐
        │          CONTROL PLANE (Panel)         │
        │  Marzban: users, plans, limits, sub URL│
        │  DB + configs + audit + API            │
        └───────────┬───────────────┬────────────┘
                    │ Node channel   │ Node channel
                    ▼                ▼
     ┌─────────────────────┐   ┌─────────────────────┐
     │ VPN NODE DE-1       │  │ VPN NODE DE-2       │
     │ Xray (VLESS REALITY)│  │ Xray (VLESS REALITY)│
     │ + (gRPC TLS backup) │  │ + (gRPC TLS backup) │
     └───────────┬─────────┘   └───────────┬─────────┘
                 │                         │
                 ▼                         ▼
            Internet users            Internet users
                 ▲
                 │
     ┌─────────────────────┐
     │ VPN NODE DE-3       │
     │ Xray (VLESS REALITY)│
     │ + (gRPC TLS backup) │
     └─────────────────────┘

```

**Ключевой принцип:** панель управляет пользователями и подписками, **VPN-трафик идёт напрямую на ноды** (не через панель).

---

## Роли компонентов

### 1) Control Plane: Панель (Marzban)

**Назначение:**

- хранит пользователей (учётки/UUID) и тарифы;
    
- выставляет сроки/лимиты;
    
- выдаёт **персональный subscription URL**;
    
- API для бота (create user / renew / disable / get link);
    
- централизованная “правда” о подписках.
    

**Важно по надёжности:**

- если панель упала, **уже выданные конфиги/подписки продолжают работать**, т.к. ноды обслуживают трафик автономно (пользователи смогут подключаться, но ты временно не сможешь управлять).
    

### 2) Worker Nodes: VPN-ноды (DE-1…DE-N)

**На каждой ноде:**

- Xray с inbound’ами:
    
    - **VLESS + TCP + REALITY** (основной “Fast”)
        
    - **VLESS + gRPC + TLS** (резерв “Mobile/Backup”)
        
- лимиты и политики применяются через управление панелью / конфигом (в зависимости от настроек).
    

**Требования к ноде:**

- стабильный канал (важнее RAM);
    
- нормальная CPU частота (важнее количества ядер на старте);
    
- понятная сеть (1 Gbps лучше, чем “до 1 Gbps” с сильным шарингом).
    

### 3) Telegram-бот (Billing / Support UI)

**Назначение:**

- принимает оплату;
    
- вызывает API панели:
    
    - создать пользователя,
        
    - продлить подписку,
        
    - отключить по сроку/лимиту,
        
    - получить subscription link;
        
- выдаёт пользователю инструкции “как подключить”.
    

**Ключевая идея:** бот не управляет нодами напрямую. Он управляет **учётками**, а не серверами.

### 4) Мониторинг и логирование (обязательный слой для “надёжности”)

- мониторинг нод: CPU/RAM/DISK/NET, latency, availability;
    
- алерты в Telegram (твой админ-чат);
    
- логирование ошибок подключения (чтобы понимать “мобилка отвалилась”, “порт режут”, “DPI усилили”).
    

---

## Пользовательская модель доступа

### Пер-пользовательская учётка (обязательно)

- **Каждый клиент** получает **свою учётку** (UUID/пользователь).
    
- Никаких “один ключ на 50 человек”.
    

### Одна подписка → много серверов

- Пользователю выдаётся **одна ссылка подписки**.
    
- Внутри подписки: “DE-1 Fast (REALITY)”, “DE-1 Mobile (gRPC)”, “DE-2 Fast…”, и т.д.
    

### Почему так лучше всего для твоей идеи

- Добавил новую ноду → добавил её в подписку → пользователи обновили подписку → готово.
    
- Нода упала → пользователь выбирает другую (или авто-режим в клиенте).
    

---

## “Балансировка” нагрузки — правильный подход для VPN

### Базовый режим (рекомендован старт)

- В подписке показываешь **несколько серверов**.
    
- Пользователь сам выбирает, либо выбирает авто-режим (если клиент умеет).
    

### “Мягкая балансировка” без балансеров

- Бот/инструкции рекомендуют “Сервер по умолчанию: DE-2”.
    
- Если DE-2 перегружен — меняешь рекомендацию на DE-3.
    
- Новым пользователям можно выдавать “первым в списке” менее загруженный сервер.
    

**Зачем так:** это настоящая балансировка пользователей без сложных L4/L7 решений.

---

## Протоколы и входы (inbounds)

### Обязательные профили в подписке

1. **Fast (default)**
    

- VLESS + TCP + REALITY
    
- цель: максимальная скорость, минимум задержки
    
- подходит: Wi-Fi / нормальная моб. сеть
    

2. **Mobile / Backup**
    

- VLESS + gRPC + TLS
    
- цель: живучесть при мобильном NAT, нестабильной сети, частых сменах IP
    

_(опционально)_ 3) **Last-chance**

- VLESS + WS + TLS (если у части пользователей совсем “тяжёлые” сети)
    

### Reality-маскировка (важно)

- SNI/ServerName: крупный “белый” домен (как в твоём примере).
    
- fingerprint: `chrome`
    
- лучше иметь **2–3 different SNI** (на случай, если какой-то домен становится проблемным).
    

---

## Лимиты и анти-абьюз (то, что делает сервис “коммерческим”)

### Минимальный набор (очень рекомендую)

- **Expiration**: срок подписки (30 дней и т.п.)
    
- **Max IP (или max active IP)**: 1–2  
    (защищает от раздачи ключа друзьям)
    
- **Traffic limit (опционально)**: например 40–200 GB/мес  
    (защищает от “качков”, предсказуемость нагрузки)
    

### Почему “лимит по IP” чаще лучше, чем “лимит соединений”

Потому что одно устройство может открывать много соединений параллельно (браузер/приложения), а “по IP” обычно честнее отражает “сколько устройств реально пользуется”.

---

## Данные и секреты (что где хранится)

### На панели

- База пользователей/тарифов/статусов
    
- Секреты доступа API
    
- Ключи/конфиги для управления нодами
    
- Токены подписок (subscription tokens)
    

### На нодах

- Только runtime-конфиг Xray (и ключи REALITY на ноде)
    
- Логи соединений/ошибок (по твоей политике хранения)
    

**Правило:** панель — это “источник истины”, ноды — “исполнители”.

---

## Отказоустойчивость (SRE-логика простыми словами)

### Что может упасть и что будет

- **Упала одна нода (DE-2)** → сервис жив, пользователи выбирают DE-1/DE-3.
    
- **Упала панель** → подключения продолжаются, но ты не можешь создавать/продлевать/банить до восстановления.
    
- **Упал бот** → VPN работает, но продажи/продления временно не автоматизированы.
    

### Минимальные меры отказоустойчивости

1. **3 ноды** в подписке (желательно с самого начала).
    
2. **Бэкап панели ежедневно** (данные + конфиги + секреты).
    
3. Мониторинг нод + алерт “нода недоступна”.
    
4. Порог загрузки: если нода постоянно >70% сети/CPU в прайм-тайм → добавлять ноду.
    

---

## Безопасность и эксплуатация

### Сетевые правила (high-level)

- Панель:
    
    - админка/панель: доступ только тебе (по IP/VPN/Zero Trust)
        
    - публично открыт только нужный endpoint подписки и API (если надо для бота)
        
- Ноды:
    
    - открыты только порты VPN (REALITY/gRPC) и минимум служебного доступа
        

### Операционные правила

- отдельные ключи/токены для бота
    
- аудит действий (кто создал/продлил/удалил)
    
- ротация секретов по необходимости
    

---

## Масштабирование до 2000 пользователей (без переделки архитектуры)

### Практическая стратегия роста

1. Старт: 2–3 ноды (DE-1..DE-3)
    
2. Когда нагрузка растёт:
    
    - добавить DE-4
        
    - добавить его в подписку
        
    - обновить “рекомендованный сервер”
        
3. Когда появляются разные регионы:
    
    - добавить NL/PL/FR как отдельные группы нод
        
    - в подписке сделать категории “Germany / Netherlands / Poland”
        

### Что считать “ёмкостью”

Не “2000 пользователей”, а “сколько **одновременно активных** и какой профиль”.  
Обычно 2000 подписчиков ≠ 2000 одновременных.

---

## Пользовательский UX (как должно выглядеть у клиента)

В подписке показывай понятные названия:

- **DE-1 Fast (REALITY)**
    
- **DE-1 Mobile (gRPC)**
    
- **DE-2 Fast (REALITY)**
    
- **DE-2 Mobile (gRPC)**
    

И короткая инструкция:

- “Сначала пробуй Fast, если в мобильной сети не подключается — выбирай Mobile.”
    

---

## Чек-лист MVP (минимально рабочий сервис)

-  Панель Marzban поднята на отдельном VPS
    
-  Подключены 2–3 ноды (DE-1..DE-3)
    
-  На каждой ноде есть 2 входа: REALITY + gRPC
    
-  Настроены тарифы: срок + Max IP + (опционально) трафик
    
-  Бот создаёт/продлевает и отправляет subscription link
    
-  Мониторинг + алерты на падение нод
    
-  Ежедневные бэкапы панели
    

---

## Рекомендуемые “дефолты” под твой кейс

- **Основной профиль:** VLESS + REALITY (TCP)
    
- **Резерв для мобилки:** VLESS + gRPC + TLS
    
- **Max IP:** 2 (или 1 для “строгого” тарифа)
    
- **Трафик:** опционально, но полезно (например 100 GB/мес для старта)
    
- **Ноды:** 3 в Германии — идеальный старт