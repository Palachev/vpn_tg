# Telegram VPN Billing Bot

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telegram-–±–æ—Ç –Ω–∞ **aiogram 3** –¥–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ VPN-—Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ –±–∞–∑–µ VLESS/REALITY —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ø–∞–Ω–µ–ª–∏ Marzban –∏ –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –º–µ–Ω—é –∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥.
- –ü–æ–∫—É–ø–∫–∞/–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ (1/3/6 –º–µ—Å—è—Ü–µ–≤) —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∏–Ω–≤–æ–π—Å–æ–≤ –∏ idempotency –Ω–∞ –≤–µ–±—Ö—É–∫–∞—Ö –æ–ø–ª–∞—Ç.
- –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Marzban, –ø–æ–ª—É—á–µ–Ω–∏–µ personal subscription link.
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è Android/iOS/Windows/macOS.
- –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –≤ –æ–¥–∏–Ω –∫–ª–∏–∫.
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å –±–æ–Ω—É—Å–Ω—ã–º–∏ –¥–Ω—è–º–∏ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ.
- FAQ/Help –∏ —É—Å–ª–æ–≤–∏—è –æ—Ñ–µ—Ä—Ç—ã.

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   ```
2. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` (–∑–Ω–∞—á–µ–Ω–∏—è —Å–º. –Ω–∏–∂–µ):
   ```env
   TELEGRAM_TOKEN=123:bot-token
   TELEGRAM_ADMIN_IDS=123456
   MARZBAN_BASE_URL=https://panel.example.com
   MARZBAN_API_KEY=secret
   PAYMENT_PROVIDER_KEY=provider-key
   PAYMENT_PUBLIC_KEY=provider-pub
   PAYMENT_WEBHOOK_SECRET=webhook-secret
   PAYMENT_CURRENCY=USD
   DATABASE_PATH=./bot.db
   WEBHOOK_HOST=0.0.0.0
   WEBHOOK_PORT=8080
   WEBHOOK_PATH=/payment/webhook
   BASE_SUBSCRIPTION_DAYS=30
   REFERRAL_BONUS_DAYS=7
   ```
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ (long polling + –≤–µ–±—Ö—É–∫ –æ–ø–ª–∞—Ç—ã):
   ```bash
   python main.py
   ```
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É webhook-–∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –∞–¥—Ä–µ—Å—É `http(s)://<host>:8080/payment/webhook` c –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `X-Signature` (HMAC-SHA256 —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞).

## –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (—Ä—É—Å—Å–∫–∏–π)
1. **–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ**
   - Python 3.11+, `pip install -r requirements.txt`.
   - –°–æ–∑–¥–∞–π—Ç–µ `.env` —Å —Ç–æ–∫–µ–Ω–∞–º–∏, –∫–ª—é—á–∞–º–∏ Marzban –∏ –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∞–ª—é—Ç—É.
   - –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Ä—É–∂—É –ø–æ—Ä—Ç –∏–∑ `WEBHOOK_PORT` –Ω–∞ reverse-proxy (Nginx/Traefik) c HTTPS.
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite (`DATABASE_PATH=./bot.db`). –î–ª—è –Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤—ã–Ω–µ—Å–∏—Ç–µ –≤ PostgreSQL –∏ –∑–∞–º–µ–Ω–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
3. **–ó–∞–ø—É—Å–∫ –ø–æ–¥ systemd**
   ```ini
   [Unit]
   Description=Telegram VPN Bot
   After=network.target

   [Service]
   WorkingDirectory=/opt/vpn-bot
   EnvironmentFile=/opt/vpn-bot/.env
   ExecStart=/opt/vpn-bot/.venv/bin/python main.py
   Restart=always
   User=bot

   [Install]
   WantedBy=multi-user.target
   ```
   –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `systemctl daemon-reload && systemctl enable --now vpn-bot`.
4. **–ó–∞–ø—É—Å–∫ –≤ Docker (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ)**
   ```bash
   docker run -d --name vpn-bot \
     --env-file .env \
     -p 8080:8080 \
     -v $(pwd)/bot.db:/app/bot.db \
     -w /app \
     python:3.11-slim bash -c "pip install -r requirements.txt && python main.py"
   ```
5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏**
   - –í Telegram –æ—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è.
   - –° –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π webhook –Ω–∞ `http(s)://<host>:<WEBHOOK_PORT><WEBHOOK_PATH>` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π HMAC-–ø–æ–¥–ø–∏—Å—å—é ‚Äî —Å—Ç–∞—Ç—É—Å 200/OK.
6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ stdout, –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è systemd/Docker.
   - –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: `git pull`, `pip install -r requirements.txt`, `systemctl restart vpn-bot`.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- `app/services` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Marzban, –ø–ª–∞—Ç–µ–∂–∞–º–∏, —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏, –ø–æ–¥–ø–∏—Å–∫–∞–º–∏, DI middleware.
- `app/repositories` ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–ª–∞—Ç–µ–∂–µ–π –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –≤ SQLite (aiosqlite), –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è idempotency.
- `app/handlers` ‚Äî Telegram UI: —Å—Ç–∞—Ä—Ç, –ø–æ–∫—É–ø–∫–∞, –ø—Ä–æ–¥–ª–µ–Ω–∏–µ, —Å—Ç–∞—Ç—É—Å, —É—Å—Ç–∞–Ω–æ–≤–∫–∞, —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞, –ø–æ–º–æ—â—å.
- `app/server.py` ‚Äî aiohttp-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∏—ë–º–∞ –≤–µ–±—Ö—É–∫–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π.
- `app/config.py` ‚Äî pydantic-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ç–∞—Ä–∏—Ñ—ã (1/3/6 –º–µ—Å—è—Ü–µ–≤).
- `main.py` ‚Äî —Å–±–æ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ + –≤–µ–±—Ö—É–∫–∞.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è
- –í—Å–µ —Ç–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ ENV, —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–æ–¥–µ.
- –í–µ–±—Ö—É–∫ –æ–ø–ª–∞—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å HMAC (idempotent –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ `payments` —Ç–∞–±–ª–∏—Ü—É).
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ–ø–ª–∞—Ç—ã/–¥—É–±–ª—å-–≤–µ–±—Ö—É–∫–∏ –Ω–µ —Å–æ–∑–¥–∞–¥—É—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö —É—á—ë—Ç–æ–∫.
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ Telegram ID —Å–æ–∑–¥–∞—ë—Ç—Å—è –µ–¥–∏–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Marzban (`tg<id>`), –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ API `/renew`.

## –¢–∏–ø–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `/start`: ¬´üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ú—ã –¥–∞—ë–º –±—ã—Å—Ç—Ä—ã–π –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π VPN‚Ä¶¬ª + –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏.
- ¬´–ö—É–ø–∏—Ç—å VPN¬ª: –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ —Å —Ü–µ–Ω–æ–π ‚Üí —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É.
- ¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å VPN¬ª: –≤—ã–±–æ—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã ‚Üí 3‚Äì4 —à–∞–≥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
- ¬´–°—Ç–∞—Ç—É—Å¬ª: –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è, –ª–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –∫–Ω–æ–ø–∫–∞ ¬´–ü—Ä–æ–¥–ª–∏—Ç—å¬ª.
- ¬´–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π¬ª: –≤—ã–¥–∞—ë—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –≤–∏–¥–∞ `https://t.me/<bot>?start=ref<id>`.
- ¬´–ü–æ–º–æ—â—å¬ª: –±—ã—Å—Ç—Ä—ã–π FAQ –∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É.

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ production
- –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ `main.py` –∑–∞ reverse-proxy (HTTPS) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø—Ä–∏—ë–º–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤ –æ–ø–ª–∞—Ç.
- –í–∫–ª—é—á–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (stdout –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç systemd/Docker). –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ä—å—Ç–µ `logging` —Ñ–æ—Ä–º–∞—Ç.
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±—ç–∫–∞–ø `bot.db` –∏ –±–∞–∑—ã Marzban; –≤—ã–Ω–µ—Å–∏—Ç–µ –ë–î –≤ –≤–Ω–µ—à–Ω–∏–π PostgreSQL –ø—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏.
- –î–æ–±–∞–≤—å—Ç–µ –≤–µ–Ω–¥–æ—Ä—Å–∫–∏–π –ø–ª–∞—Ç—ë–∂–Ω—ã–π SDK –≤ `PaymentService` (–º–µ—Ç–æ–¥ `create_invoice` –∏ `verify_webhook`).
